<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>部署Rails项目(结合nginx和puma) | Andrew’s Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="部署Rails项目(结合nginx和puma)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="准备好服务器上的部署账号及目录结构" />
<meta property="og:description" content="准备好服务器上的部署账号及目录结构" />
<link rel="canonical" href="https://blog.ky2020.store/rails/2016/11/15/how-to-deploy-rails-app-with-nginx-and-puma.html" />
<meta property="og:url" content="https://blog.ky2020.store/rails/2016/11/15/how-to-deploy-rails-app-with-nginx-and-puma.html" />
<meta property="og:site_name" content="Andrew’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-11-15T03:09:40+00:00" />
<script type="application/ld+json">
{"description":"准备好服务器上的部署账号及目录结构","headline":"部署Rails项目(结合nginx和puma)","dateModified":"2016-11-15T03:09:40+00:00","url":"https://blog.ky2020.store/rails/2016/11/15/how-to-deploy-rails-app-with-nginx-and-puma.html","datePublished":"2016-11-15T03:09:40+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.ky2020.store/rails/2016/11/15/how-to-deploy-rails-app-with-nginx-and-puma.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.ky2020.store/feed.xml" title="Andrew's Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrew&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">关于我</a><a class="page-link" href="/projects.html">项目列表</a><a class="page-link" href="/toolbox.html">工具箱</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">部署Rails项目(结合nginx和puma)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-11-15T03:09:40+00:00" itemprop="datePublished">Nov 15, 2016
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="准备好服务器上的部署账号及目录结构">准备好服务器上的部署账号及目录结构</h1>

<h2 id="安装必要的包">安装必要的包</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update

apt-get <span class="nb">install </span>curl git build-essential zlibc zlib1g-dev zlib1g libcurl4-openssl-dev libssl-dev libopenssl-ruby libapr1-dev libaprutil1-dev libreadline6 libreadline6-dev <span class="nt">-y</span>
</code></pre></div></div>

<h2 id="创建新的用户">创建新的用户</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>useradd <span class="nt">-m</span> wyb <span class="nt">-s</span> /bin/bash <span class="c"># -m create home folder</span>
passwd wyb
groupadd deployers
usermod <span class="nt">-a</span> <span class="nt">-G</span> deployers wyb
</code></pre></div></div>

<h2 id="更改默认编辑器">更改默认编辑器</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update-alternatives <span class="nt">--config</span> editor
</code></pre></div></div>

<h2 id="将用户wyb添加到sudoer">将用户<strong>wyb</strong>添加到<strong>sudoer</strong></h2>

<p>将下面的内容</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wyb     ALL=(ALL:ALL) ALL
</code></pre></div></div>

<p>添加到<strong>visudo</strong></p>

<h2 id="配置ssh无密码登录">配置ssh无密码登录</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> ~/.ssh/id_rsa.pub | ssh wyb@hostname <span class="s2">"mkdir ~/.ssh; cat &gt;&gt; ~/.ssh/authorized_keys"</span>
</code></pre></div></div>

<h2 id="创建部署目录">创建部署目录</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /var/www
<span class="nb">chown</span> <span class="nt">-R</span> wyb:deployers /var/www
<span class="nb">chmod</span> <span class="nt">-R</span> g+w /var/www
</code></pre></div></div>

<h2 id="安装rvm">安装rvm</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg <span class="nt">--keyserver</span> hkp://keys.gnupg.net <span class="nt">--recv-keys</span> 409B6B1796C275462A1703113804BB82D39DC0E3
<span class="se">\c</span>url https://raw.githubusercontent.com/rvm/rvm/master/binscripts/rvm-installer | bash <span class="nt">-s</span> stable
<span class="nb">source</span> /etc/profile.d/rvm.sh  <span class="c"># able to use rvm</span>
rvm <span class="nb">install </span>2.3.1
rvm use 2.3.1
rvm gemset use rate_tool <span class="nt">--create</span>
gem <span class="nb">install </span>bundler <span class="nt">--no-ri</span> <span class="nt">--no-rdoc</span>
</code></pre></div></div>

<h2 id="安装nginx">安装nginx</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>nginx <span class="nt">-y</span>
groupadd nginx
usermod <span class="nt">-a</span> <span class="nt">-G</span> nginx wyb
</code></pre></div></div>

<h2 id="安装redis">安装redis</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://download.redis.io/releases/redis-stable.tar.gz
<span class="nb">tar </span>xzf redis-stable.tar.gz
apt-get <span class="nb">install </span>tcl8.5 <span class="nt">-y</span>
<span class="nb">cd </span>redis-stable
make
make <span class="nb">test
</span>make <span class="nb">install
cd </span>utils
./install_server.sh

</code></pre></div></div>

<h2 id="安装postgresql">安装postgresql</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>postgresql postgresql-contrib <span class="nt">-y</span>
apt-get <span class="nb">install </span>libpq-dev <span class="nt">-y</span>
su postgres
createuser <span class="nt">--createdb</span> <span class="nt">--superuser</span> <span class="nt">-U</span> postgres wyb

psql <span class="nt">-c</span> <span class="s2">"ALTER USER wyb WITH PASSWORD ''"</span>

psql <span class="nt">-c</span> <span class="s2">"create database rate_tool owner wyb encoding 'UTF8' TEMPLATE template0;"</span>

psql <span class="nt">-d</span> rate_tool <span class="nt">-c</span> <span class="s2">"CREATE EXTENSION hstore;"</span>

psql <span class="nt">-d</span> rate_tool <span class="nt">-c</span> <span class="s2">"CREATE EXTENSION pg_trgm;"</span>

<span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>rake db:migrate
</code></pre></div></div>

<h2 id="安装yarn">安装yarn</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
sudo apt update
sudo apt install yarn
</code></pre></div></div>

<h2 id="安装monit">安装monit</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>monit <span class="nt">-y</span>
</code></pre></div></div>

<p>将下面内容添加到<strong>visudo</strong>文件里，运行<code class="language-plaintext highlighter-rouge">sudo monit summary</code>命令时不需要输入密码</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wyb     ALL=NOPASSWD:/usr/bin/monit
</code></pre></div></div>
<h2 id="import-link-files">import link files</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp -r /var/www/rate_tool/shared/config/* wyb@hostname:/var/www/rate_tool/shared/config/
scp -r /etc/monit/conf.d/* wyb@hostname:/etc/monit/conf.d/
scp -r /etc/monit/monitrc wyb@hostname:/etc/monit/monitrc
scp bin/* wyb@hostname:/var/www/rate_tool/shared/bin/
</code></pre></div></div>

<h2 id="import-server-scripts">import server scripts</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /var/www/rate_tool/shared/scripts
scp wyb@hostname:/var/www/rate_tool/shared/scripts/* /var/www/rate_tool/shared/scripts/
scp /etc/nginx/conf.d/rate_tool.conf root@hostname:/etc/nginx/sites-enabled/
mkdir -p /etc/nginx/ssl/rate_tool
scp /etc/nginx/ssl/rate_tool/* root@hostname:/etc/nginx/ssl/rate_tool/
</code></pre></div></div>

<h1 id="import-images">import images</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp -r wyb@hostname:/var/www/rate_tool/shared/public/uploads/* /var/www/rate_tool/shared/public/uploads
</code></pre></div></div>

<h1 id="puma常用命令">puma常用命令</h1>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">exec </span>pumactl <span class="nt">-F</span> config/puma.rb start
bundle <span class="nb">exec </span>pumactl <span class="nt">-F</span> config/puma.rb status
bundle <span class="nb">exec </span>pumactl <span class="nt">-F</span> config/puma.rb stop
</code></pre></div></div>
<h1 id="tips">tips</h1>

<h2 id="1-there-is-no-public-key-available-for-the-following-key-ids">1. There is no public key available for the following key IDs:</h2>

<p><a href="http://unix.stackexchange.com/a/209266">解决方法</a></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>debian-archive-keyring
apt-key update
</code></pre></div></div>

<h2 id="2upgrade-debian-to-the-latest-version-in-one-line">2.Upgrade debian to the latest version in one line</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update<span class="p">;</span>apt-get upgrade<span class="p">;</span>wget <span class="nt">-q</span> https://www.rootusers.com/wp-content/uploads/2015/08/update.txt <span class="nt">-O</span> /etc/apt/sources.list<span class="p">;</span>apt-get update<span class="p">;</span>apt-get upgrade<span class="p">;</span>apt-get dist-upgrade<span class="p">;</span>apt-get autoremove<span class="p">;</span><span class="nb">cat</span> /etc/debian_version<span class="p">;</span><span class="nb">echo</span> <span class="s2">"The above number shows the current Debian version. It is highly recommended that you reboot the system."</span>
</code></pre></div></div>

<p>Options:</p>

<h2 id="install-java-on-ubuntu">Install java on ubuntu</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>default-jre
apt-get <span class="nb">install </span>default-jdk
</code></pre></div></div>

<p>options:</p>
<h2 id="firewall-problem-on-centos">Firewall problem on CentOS</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
</code></pre></div></div>

<p>Options:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 备份所有的数据库
su - postgres -c 'mkdir /tmp/pg_backup; pg_dumpall &gt; /tmp/pg_backup/dumpall-$(date '+%F').sql'
# 导入所有数据库
psql -f  pgdumpall-2018-11-20.sql postgres
</code></pre></div></div>

  </div><a class="u-url" href="/rails/2016/11/15/how-to-deploy-rails-app-with-nginx-and-puma.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Andrew&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Andrew&#39;s Blog</li><li><a class="u-email" href="mailto:zzcv20051122@126.com">zzcv20051122@126.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/yyandrew"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">yyandrew</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A Rubyist&#39;s Blog.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
